{
  "name": "Anemia Medications for Seniors",
  "pinned": false,
  "createdAt": 1758961093030,
  "preset": "@local:m3-benchmark",
  "tokenCount": 4805,
  "systemPrompt": "",
  "messages": [
    {
      "versions": [
        {
          "type": "singleStep",
          "role": "user",
          "content": [
            {
              "type": "text",
              "text": "Among patients who were diagnosed with anemia, unspecified since 2100, what are the top three most commonly prescribed medications that followed during the same hospital visit for patients in their 60 or above?"
            }
          ]
        }
      ],
      "currentlySelected": 0
    },
    {
      "versions": [
        {
          "type": "multiStep",
          "role": "assistant",
          "senderInfo": {
            "senderName": "openai/gpt-oss-20b"
          },
          "steps": [
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961098936-0.3178891586448025",
              "content": [
                {
                  "type": "text",
                  "text": "The user asks: \"Among patients who were diagnosed with anemia, unspecified since 2100, what are the top three most commonly prescribed medications that followed during the same hospital visit for patients in their 60 or above?\"\n\nWe need to interpret. They want patients with a diagnosis of anemia unspecified (ICD code maybe). Since 2100 likely refers to year 2021? Actually \"since 2100\" might be a typo meaning since 2000? Could be ICD-9 code 285.x for anemia unspecified. We need to find diagnoses in MIMIC-IV.\n\nWe need to identify patients diagnosed with anemia unspecified, during hospital visits (admissions). Then among those patients who are age 60 or above at admission. For each such patient, we want medications prescribed following the diagnosis during same visit. Probably medication orders from prescriptions table: 'prescriptions' in MIMIC. We then count frequency of medications.\n\nWe need top three most common meds.\n\nThus query needs to join admissions, diagnoses (diagnoses_icd10?), but MIMIC-IV uses ICD-9 codes? Actually MIMIC-IV has diagnosis icd9 table maybe diagnoses_icd. Anemia unspecified likely code 285.8 or 285.9? Let's check. Use get_database_schema then get_table_info for 'diagnoses_icd' and 'prescriptions'.\n\nLet's run get_database_schema.",
                  "fromDraftModel": false,
                  "tokensCount": 281,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for 5.45 seconds"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961104572-0.22840798596626644",
              "callId": 849489520600852,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 23
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961104742-0.23521249169538594",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600852,
                  "toolCallRequestId": "458465004",
                  "name": "get_database_schema",
                  "parameters": {},
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 49.666919167582435,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 1.01,
                  "totalTimeSec": 6.08,
                  "promptTokensCount": 1376,
                  "predictedTokensCount": 302,
                  "totalTokensCount": 1678
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961104765-0.6336867383058171",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600852,
                  "toolCallRequestId": "458465004",
                  "content": "[{\"type\":\"text\",\"text\":\"üîß **Current Backend:** SQLite (local database)\\nüìÅ **Database Path:** /Users/rafraf/Documents/code/MIT/m3/data/databases/mimic_iv.sqlite\\n\\nüìã **Available Tables:**\\n              name\\n        admissions\\n       chartevents\\n              cost\\n   d_icd_diagnoses\\n  d_icd_procedures\\n           d_items\\n        d_labitems\\n     diagnoses_icd\\n          icustays\\n       inputevents\\n         labevents\\nmicrobiologyevents\\n      outputevents\\n          patients\\n     prescriptions\\n    procedures_icd\\n         transfers\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961105406-0.6990680904014466",
              "content": [
                {
                  "type": "text",
                  "text": "Now get_table_info for diagnoses_icd and prescriptions.",
                  "fromDraftModel": false,
                  "tokensCount": 11,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961105598-0.4036001034358879",
              "callId": 849489520600853,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 7
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961106028-0.71512175145085",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600853,
                  "toolCallRequestId": "872804905",
                  "name": "get_table_info",
                  "parameters": {
                    "table_name": "diagnoses_icd",
                    "show_sample": true
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 47.846161541690314,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.288,
                  "totalTimeSec": 0.919,
                  "promptTokensCount": 1829,
                  "predictedTokensCount": 44,
                  "totalTokensCount": 1873
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961106035-0.19367921467480542",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600853,
                  "toolCallRequestId": "872804905",
                  "content": "[{\"type\":\"text\",\"text\":\"üîß **Current Backend:** SQLite (local database)\\nüìÅ **Database Path:** /Users/rafraf/Documents/code/MIT/m3/data/databases/mimic_iv.sqlite\\nüìã **Table:** diagnoses_icd\\n\\n**Column Information:**\\n cid       name         type  notnull dflt_value  pk\\n   0     row_id          INT        1       None   1\\n   1 subject_id          INT        1       None   0\\n   2    hadm_id          INT        1       None   0\\n   3   icd_code  VARCHAR(10)        1       None   0\\n   4  charttime TIMESTAMP(0)        1       None   0\\n\\nüìä **Sample Data (first 3 rows):**\\n row_id  subject_id  hadm_id   icd_code           charttime\\n      0    10035185 22580999  icd9|4139 2100-05-17 12:53:00\\n      1    10035185 22580999  icd9|v707 2100-05-17 12:53:00\\n      2    10035185 22580999 icd9|41401 2100-05-17 12:53:00\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961106819-0.06432792560446088",
              "content": [
                {
                  "type": "text",
                  "text": "Get table info for prescriptions.",
                  "fromDraftModel": false,
                  "tokensCount": 6,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961107024-0.8416191763192916",
              "callId": 849489520600854,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 6
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961107435-0.36036420929728186",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600854,
                  "toolCallRequestId": "655454955",
                  "name": "get_table_info",
                  "parameters": {
                    "table_name": "prescriptions",
                    "show_sample": true
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 45.174673368797485,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.563,
                  "totalTimeSec": 0.819,
                  "promptTokensCount": 2186,
                  "predictedTokensCount": 37,
                  "totalTokensCount": 2223
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961107441-0.9969354216080147",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600854,
                  "toolCallRequestId": "655454955",
                  "content": "[{\"type\":\"text\",\"text\":\"üîß **Current Backend:** SQLite (local database)\\nüìÅ **Database Path:** /Users/rafraf/Documents/code/MIT/m3/data/databases/mimic_iv.sqlite\\nüìã **Table:** prescriptions\\n\\n**Column Information:**\\n cid         name         type  notnull dflt_value  pk\\n   0       row_id          INT        1       None   1\\n   1   subject_id          INT        1       None   0\\n   2      hadm_id          INT        1       None   0\\n   3    starttime TIMESTAMP(0)        1       None   0\\n   4     stoptime TIMESTAMP(0)        0       None   0\\n   5         drug VARCHAR(255)        1       None   0\\n   6  dose_val_rx VARCHAR(100)        1       None   0\\n   7 dose_unit_rx  VARCHAR(50)        1       None   0\\n   8        route  VARCHAR(50)        1       None   0\\n\\nüìä **Sample Data (first 3 rows):**\\n row_id  subject_id  hadm_id           starttime            stoptime    drug dose_val_rx dose_unit_rx route\\n      0    10020740 23831430 2100-04-19 11:00:00 2100-04-20 22:00:00 insulin         0.0         unit    sc\\n      1    10005817 20626031 2100-12-20 02:00:00 2100-12-21 12:00:00 insulin         0.0         unit    sc\\n      2    10005817 20626031 2100-12-27 10:00:00 2100-12-28 19:00:00 insulin         0.0         unit    sc\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961108561-0.1474963426658661",
              "content": [
                {
                  "type": "text",
                  "text": "We need patients age >=60 at admission. Age is in patients table. Let's get patient info.",
                  "fromDraftModel": false,
                  "tokensCount": 20,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961108989-0.11825691803945293",
              "callId": 849489520600855,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 5
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961109411-0.01761970506115118",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600855,
                  "toolCallRequestId": "853285544",
                  "name": "get_table_info",
                  "parameters": {
                    "table_name": "patients",
                    "show_sample": true
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 40.665250973729435,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.721,
                  "totalTimeSec": 1.229,
                  "promptTokensCount": 2668,
                  "predictedTokensCount": 50,
                  "totalTokensCount": 2718
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961109416-0.09770631966223065",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600855,
                  "toolCallRequestId": "853285544",
                  "content": "[{\"type\":\"text\",\"text\":\"üîß **Current Backend:** SQLite (local database)\\nüìÅ **Database Path:** /Users/rafraf/Documents/code/MIT/m3/data/databases/mimic_iv.sqlite\\nüìã **Table:** patients\\n\\n**Column Information:**\\n cid       name         type  notnull dflt_value  pk\\n   0     row_id          INT        1       None   1\\n   1 subject_id          INT        1       None   0\\n   2     gender   VARCHAR(5)        1       None   0\\n   3        dob TIMESTAMP(0)        1       None   0\\n   4        dod TIMESTAMP(0)        0       None   0\\n\\nüìä **Sample Data (first 3 rows):**\\n row_id  subject_id gender                 dob  dod\\n      0    10014729      f 2079-07-22 00:00:00 None\\n      1    10003400      f 2028-07-25 00:00:00 None\\n      2    10002428      f 2020-07-30 00:00:00 None\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961110075-0.6860040063548513",
              "content": [
                {
                  "type": "text",
                  "text": "Now admissions table.",
                  "fromDraftModel": false,
                  "tokensCount": 4,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961110307-0.4955959745025017",
              "callId": 849489520600856,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 7
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961110775-0.7789346220522677",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600856,
                  "toolCallRequestId": "585166253",
                  "name": "get_table_info",
                  "parameters": {
                    "table_name": "admissions",
                    "show_sample": true
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 39.728980247886135,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.458,
                  "totalTimeSec": 0.88,
                  "promptTokensCount": 2998,
                  "predictedTokensCount": 35,
                  "totalTokensCount": 3033
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961110782-0.23583835638528106",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600856,
                  "toolCallRequestId": "585166253",
                  "content": "[{\"type\":\"text\",\"text\":\"üîß **Current Backend:** SQLite (local database)\\nüìÅ **Database Path:** /Users/rafraf/Documents/code/MIT/m3/data/databases/mimic_iv.sqlite\\nüìã **Table:** admissions\\n\\n**Column Information:**\\n cid               name         type  notnull dflt_value  pk\\n   0             row_id          INT        1       None   1\\n   1         subject_id          INT        1       None   0\\n   2            hadm_id          INT        1       None   0\\n   3          admittime TIMESTAMP(0)        1       None   0\\n   4          dischtime TIMESTAMP(0)        0       None   0\\n   5     admission_type  VARCHAR(50)        1       None   0\\n   6 admission_location  VARCHAR(50)        1       None   0\\n   7 discharge_location  VARCHAR(50)        0       None   0\\n   8          insurance VARCHAR(255)        1       None   0\\n   9           language  VARCHAR(10)        0       None   0\\n  10     marital_status  VARCHAR(50)        0       None   0\\n  11                age          INT        1       None   0\\n\\nüìä **Sample Data (first 3 rows):**\\n row_id  subject_id  hadm_id           admittime           dischtime admission_type     admission_location       discharge_location insurance language marital_status  age\\n      0    10004235 24181354 2100-03-19 14:38:00 2100-03-28 14:02:00         urgent transfer from hospital skilled nursing facility  medicaid  english         single   47\\n      1    10009628 25926192 2100-09-30 17:08:00 2100-10-08 13:20:00         urgent transfer from hospital         home health care  medicaid        ?        married   58\\n      2    10006053 22942076 2100-11-15 23:39:00 2100-11-17 17:20:00         urgent transfer from hospital                     died  medicaid  english           None   52\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961112079-0.3431524489834298",
              "content": [
                {
                  "type": "text",
                  "text": "The admissions table already has age column. So we can use that.\n\nNow need to find anemia unspecified diagnoses in diagnoses_icd. ICD code for anemia unspecified likely icd9|285.8? Let's search. We can filter by icd_code like 'icd9|285%'? But we need unspecified. Let's look at sample codes: In the sample, we saw icd9|4139 etc. We'll query to see unique icd_codes that start with 285 maybe.",
                  "fromDraftModel": false,
                  "tokensCount": 99,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for 2.53 seconds"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961115195-0.9420620738265265",
              "callId": 849489520600857,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 19
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961115920-0.8926313825258835",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600857,
                  "toolCallRequestId": "845366201",
                  "name": "execute_mimic_query",
                  "parameters": {
                    "sql_query": "SELECT DISTINCT icd_code FROM diagnoses_icd WHERE icd_code LIKE 'icd9|285%' LIMIT 20;"
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 35.01944880807284,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.886,
                  "totalTimeSec": 4.226,
                  "promptTokensCount": 3563,
                  "predictedTokensCount": 148,
                  "totalTokensCount": 3711
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961115939-0.4821696797279552",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600857,
                  "toolCallRequestId": "845366201",
                  "content": "[{\"type\":\"text\",\"text\":\"  icd_code\\n icd9|2859\\n icd9|2851\\nicd9|28521\\nicd9|28529\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961116947-0.2858849571849411",
              "content": [
                {
                  "type": "text",
                  "text": "So codes: 2859, 2851, 28521, 28529. Which is unspecified? 2859 maybe unspecified anemia. Let's confirm by referencing ICD-9: 285.9 = Anemia, unspecified. Yes.\n\nThus we filter icd_code = 'icd9|2859'.\n\nNow need to find prescriptions that follow during same hospital visit for patients age >=60. The same admission is indicated by hadm_id in both diagnoses and prescriptions. So join admissions (for age), diagnoses_icd (filter code), prescriptions. Also we want \"medications that followed\" meaning after the diagnosis time? We could filter prescription starttime > charttime of diagnosis. That ensures medication follows. Also within same admission.\n\nSo query: select drug, count(*) as freq from ... group by drug order by freq desc limit 3.\n\nNeed to restrict to patients age >=60 at admission. admissions.age column.\n\nLet's craft SQL:\n\nSELECT p.drug, COUNT(*) AS num\nFROM prescriptions p\nJOIN diagnoses_icd d ON p.hadm_id = d.hadm_id AND d.icd_code = 'icd9|2859'\nJOIN admissions a ON p.hadm_id = a.hadm_id\nWHERE a.age >= 60 AND p.starttime > d.charttime\nGROUP BY p.drug\nORDER BY num DESC\nLIMIT 3;\n\nLet's run.",
                  "fromDraftModel": false,
                  "tokensCount": 282,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for 7.76 seconds"
              }
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961125349-0.4893346249035464",
              "callId": 849489520600858,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 39
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961128012-0.6271115172509619",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600858,
                  "toolCallRequestId": "483363990",
                  "name": "execute_mimic_query",
                  "parameters": {
                    "sql_query": "SELECT p.drug, COUNT(*) AS num\nFROM prescriptions p\nJOIN diagnoses_icd d ON p.hadm_id = d.hadm_id AND d.icd_code = 'icd9|2859'\nJOIN admissions a ON p.hadm_id = a.hadm_id\nWHERE a.age >= 60 AND p.starttime > d.charttime\nGROUP BY p.drug\nORDER BY num DESC\nLIMIT 3;"
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 33.51599835992779,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.261,
                  "totalTimeSec": 11.756,
                  "promptTokensCount": 3771,
                  "predictedTokensCount": 394,
                  "totalTokensCount": 4165
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961128052-0.6497301438861449",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600858,
                  "toolCallRequestId": "483363990",
                  "content": "[{\"type\":\"text\",\"text\":\"                       drug  num\\n                    insulin   26\\n       0.9% sodium chloride   24\\nsodium chloride 0.9%  flush   18\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961129110-0.7426841625948744",
              "content": [
                {
                  "type": "text",
                  "text": "Results show top three drugs: insulin, 0.9% sodium chloride, sodium chloride 0.9% flush.\n\nBut check that these are prescriptions during same visit after anemia diagnosis. Might be plausible.\n\nNow produce answer.",
                  "fromDraftModel": false,
                  "tokensCount": 46,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>",
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961130391-0.6392588965824244",
              "content": [
                {
                  "type": "text",
                  "text": "<|start|>assistant<|channel|>final<|message|>",
                  "fromDraftModel": false,
                  "tokensCount": 6,
                  "isStructural": true
                },
                {
                  "type": "text",
                  "text": "**Top 3 medications prescribed‚ÄØafter an ‚ÄúAnemia ‚Äì unspecified‚Äù (ICD‚Äë9‚ÄØ285.9) diagnosis for patients ‚â•60‚ÄØyears old in the same admission**\n\n| Rank | Medication (drug name)         | # of prescriptions |\n|------|--------------------------------|---------------------|\n| 1    | **Insulin**                    | 26                  |\n| 2    | **0.9‚ÄØ% Sodium Chloride**      | 24                  |\n| 3    | **Sodium chloride 0.9‚ÄØ% flush** | 18                  |\n\n*These counts come from the MIMIC‚ÄëIV database by joining `prescriptions` with `diagnoses_icd` (filtered for ICD‚Äë9 code `2859`) and `admissions` (age‚ÄØ‚â•‚ÄØ60). The query further restricted prescriptions to those started **after** the charttime of the anemia diagnosis within the same admission.*",
                  "fromDraftModel": false,
                  "tokensCount": 188,
                  "isStructural": false
                }
              ],
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 31.941288522008787,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 0.472,
                  "totalTimeSec": 7.67,
                  "promptTokensCount": 4229,
                  "predictedTokensCount": 245,
                  "totalTokensCount": 4474
                }
              },
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "debugInfoBlock",
              "stepIdentifier": "1758961136228-0.8527536130440397",
              "debugInfo": "Conversation naming technique: 'prompt'"
            }
          ]
        }
      ],
      "currentlySelected": 0
    },
    {
      "versions": [
        {
          "type": "singleStep",
          "role": "user",
          "content": [
            {
              "type": "text",
              "text": "what was the 4th? "
            }
          ]
        }
      ],
      "currentlySelected": 0
    },
    {
      "versions": [
        {
          "type": "multiStep",
          "role": "assistant",
          "steps": [
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961220483-0.5373545000766248",
              "content": [
                {
                  "type": "text",
                  "text": "We need to provide the fourth most common medication. We have counts for top 3: insulin, 0.9% sodium chloride, sodium chloride flush. To get 4th, we can run query ordering by num desc limit 5 and skip first three. Or just extend earlier query with limit 4? Let's modify query to order by num desc limit 4 and then present fourth.\n\nWe need to run new query: SELECT drug, COUNT(*) AS num FROM prescriptions p JOIN diagnoses_icd d ON ... same join conditions. Order by num DESC LIMIT 4; Then we can output the 4th row.\n\nLet's do that.",
                  "fromDraftModel": false,
                  "tokensCount": 130,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for 3.49 seconds"
              },
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>"
            },
            {
              "type": "toolStatus",
              "stepIdentifier": "1758961224236-0.9223066062370793",
              "callId": 849489520600859,
              "statusState": {
                "status": {
                  "type": "toolCallSucceeded",
                  "timeMs": 42
                },
                "customStatus": "",
                "customWarnings": []
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961227223-0.718384069108216",
              "content": [
                {
                  "type": "toolCallRequest",
                  "callId": 849489520600859,
                  "toolCallRequestId": "488926664",
                  "name": "execute_mimic_query",
                  "parameters": {
                    "sql_query": "SELECT p.drug, COUNT(*) AS num\nFROM prescriptions p\nJOIN diagnoses_icd d ON p.hadm_id = d.hadm_id AND d.icd_code = 'icd9|2859'\nJOIN admissions a ON p.hadm_id = a.hadm_id\nWHERE a.age >= 60 AND p.starttime > d.charttime\nGROUP BY p.drug\nORDER BY num DESC\nLIMIT 4;"
                  },
                  "pluginIdentifier": "mcp/m3"
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 34.29445897117748,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 6.041,
                  "totalTimeSec": 7.115,
                  "promptTokensCount": 3691,
                  "predictedTokensCount": 244,
                  "totalTokensCount": 3935
                }
              }
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961227265-0.5954336838807973",
              "content": [
                {
                  "type": "toolCallResult",
                  "callId": 849489520600859,
                  "toolCallRequestId": "488926664",
                  "content": "[{\"type\":\"text\",\"text\":\"                       drug  num\\n                    insulin   26\\n       0.9% sodium chloride   24\\nsodium chloride 0.9%  flush   18\\n                5% dextrose   18\"}]"
                }
              ],
              "roleOverride": "tool",
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961232763-0.9068696411627688",
              "content": [
                {
                  "type": "text",
                  "text": "The fourth medication is \"5% dextrose\" with 18 prescriptions (same count as the third). Provide that.",
                  "fromDraftModel": false,
                  "tokensCount": 25,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "style": {
                "type": "thinking",
                "ended": true,
                "title": "Thought for a brief moment"
              },
              "prefix": "<|channel|>analysis<|message|>",
              "suffix": "<|end|>"
            },
            {
              "type": "contentBlock",
              "stepIdentifier": "1758961233370-0.646018244465933",
              "content": [
                {
                  "type": "text",
                  "text": "<|start|>assistant<|channel|>final<|message|>",
                  "fromDraftModel": false,
                  "tokensCount": 6,
                  "isStructural": true
                },
                {
                  "type": "text",
                  "text": "**Fourth most common medication**\n\n| Rank | Medication (drug name) | # of prescriptions |\n|------|------------------------|---------------------|\n| 4    | **5‚ÄØ% Dextrose**       | 18                  |\n\nThis comes directly from the same query set used for the top three‚Äîprescriptions linked to an ICD‚Äë9‚ÄØ285.9 ‚ÄúAnemia ‚Äì unspecified‚Äù diagnosis in admissions where patients were aged‚ÄØ‚â•‚ÄØ60 and started after the charttime of that diagnosis.",
                  "fromDraftModel": false,
                  "tokensCount": 99,
                  "isStructural": false
                }
              ],
              "defaultShouldIncludeInContext": true,
              "shouldIncludeInContext": true,
              "genInfo": {
                "indexedModelIdentifier": "openai/gpt-oss-20b",
                "identifier": "openai/gpt-oss-20b",
                "loadModelConfig": {
                  "fields": [
                    {
                      "key": "llm.load.llama.cpuThreadPoolSize",
                      "value": 7
                    },
                    {
                      "key": "llm.load.contextLength",
                      "value": 32000
                    },
                    {
                      "key": "llm.load.numExperts",
                      "value": 4
                    },
                    {
                      "key": "llm.load.llama.acceleration.offloadRatio",
                      "value": 1
                    }
                  ]
                },
                "predictionConfig": {
                  "fields": [
                    {
                      "key": "llm.prediction.promptTemplate",
                      "value": {
                        "type": "jinja",
                        "jinjaPromptTemplate": {
                          "template": "{#-\n  In addition to the normal inputs of `messages` and `tools`, this template also accepts the\n  following kwargs:\n  - \"builtin_tools\": A list, can contain \"browser\" and/or \"python\".\n  - \"model_identity\": A string that optionally describes the model identity.\n  - \"reasoning_effort\": A string that describes the reasoning effort, defaults to \"medium\".\n #}\n\n{#- Tool Definition Rendering ============================================== #}\n{%- macro render_typescript_type(param_spec, required_params, is_nullable=false) -%}\n    {%- if param_spec.type == \"array\" -%}\n        {%- if param_spec['items'] -%}\n            {%- if param_spec['items']['type'] == \"string\" -%}\n                {{- \"string[]\" }}\n            {%- elif param_spec['items']['type'] == \"number\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"integer\" -%}\n                {{- \"number[]\" }}\n            {%- elif param_spec['items']['type'] == \"boolean\" -%}\n                {{- \"boolean[]\" }}\n            {%- else -%}\n                {%- set inner_type = render_typescript_type(param_spec['items'], required_params) -%}\n                {%- if inner_type == \"object | object\" or inner_type|length > 50 -%}\n                    {{- \"any[]\" }}\n                {%- else -%}\n                    {{- inner_type + \"[]\" }}\n                {%- endif -%}\n            {%- endif -%}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- else -%}\n            {{- \"any[]\" }}\n            {%- if param_spec.nullable -%}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type is defined and param_spec.type is iterable and param_spec.type is not string and param_spec.type is not mapping and param_spec.type[0] is defined -%}\n        {#- Handle array of types like [\"object\", \"object\"] from Union[dict, list] #}\n        {%- if param_spec.type | length > 1 -%}\n            {{- param_spec.type | join(\" | \") }}\n        {%- else -%}\n            {{- param_spec.type[0] }}\n        {%- endif -%}\n    {%- elif param_spec.oneOf -%}\n        {#- Handle oneOf schemas - check for complex unions and fallback to any #}\n        {%- set has_object_variants = false -%}\n        {%- for variant in param_spec.oneOf -%}\n            {%- if variant.type == \"object\" -%}\n                {%- set has_object_variants = true -%}\n            {%- endif -%}\n        {%- endfor -%}\n        {%- if has_object_variants and param_spec.oneOf|length > 1 -%}\n            {{- \"any\" }}\n        {%- else -%}\n            {%- for variant in param_spec.oneOf -%}\n                {{- render_typescript_type(variant, required_params) -}}\n                {%- if variant.description %}\n                    {{- \"// \" + variant.description }}\n                {%- endif -%}\n                {%- if variant.default is defined %}\n                    {{ \"// default: \" + variant.default|tojson }}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \" | \" }}\n                {% endif -%}\n            {%- endfor -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"string\" -%}\n        {%- if param_spec.enum -%}\n            {{- '\"' + param_spec.enum|join('\" | \"') + '\"' -}}\n        {%- else -%}\n            {{- \"string\" }}\n            {%- if param_spec.nullable %}\n                {{- \" | null\" }}\n            {%- endif -%}\n        {%- endif -%}\n    {%- elif param_spec.type == \"number\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"integer\" -%}\n        {{- \"number\" }}\n    {%- elif param_spec.type == \"boolean\" -%}\n        {{- \"boolean\" }}\n\n    {%- elif param_spec.type == \"object\" -%}\n        {%- if param_spec.properties -%}\n            {{- \"{\n\" }}\n            {%- for prop_name, prop_spec in param_spec.properties.items() -%}\n                {{- prop_name -}}\n                {%- if prop_name not in (param_spec.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{ render_typescript_type(prop_spec, param_spec.required or []) }}\n                {%- if not loop.last -%}\n                    {{-\", \" }}\n                {%- endif -%}\n            {%- endfor -%}\n            {{- \"}\" }}\n        {%- else -%}\n            {{- \"object\" }}\n        {%- endif -%}\n    {%- else -%}\n        {{- \"any\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{%- macro render_tool_namespace(namespace_name, tools) -%}\n    {{- \"## \" + namespace_name + \"\n\n\" }}\n    {{- \"namespace \" + namespace_name + \" {\n\n\" }}\n    {%- for tool in tools %}\n        {%- set tool = tool.function %}\n        {{- \"// \" + tool.description + \"\n\" }}\n        {{- \"type \"+ tool.name + \" = \" }}\n        {%- if tool.parameters and tool.parameters.properties %}\n            {{- \"(_: {\n\" }}\n            {%- for param_name, param_spec in tool.parameters.properties.items() %}\n                {%- if param_spec.description %}\n                    {{- \"// \" + param_spec.description + \"\n\" }}\n                {%- endif %}\n                {{- param_name }}\n                {%- if param_name not in (tool.parameters.required or []) -%}\n                    {{- \"?\" }}\n                {%- endif -%}\n                {{- \": \" }}\n                {{- render_typescript_type(param_spec, tool.parameters.required or []) }}\n                {%- if param_spec.default is defined -%}\n                    {%- if param_spec.enum %}\n                        {{- \", // default: \" + param_spec.default }}\n                    {%- elif param_spec.oneOf %}\n                        {{- \"// default: \" + param_spec.default }}\n                    {%- else %}\n                        {{- \", // default: \" + param_spec.default|tojson }}\n                    {%- endif -%}\n                {%- endif -%}\n                {%- if not loop.last %}\n                    {{- \",\n\" }}\n                {%- else %}\n                    {{- \"\n\" }}\n                {%- endif -%}\n            {%- endfor %}\n            {{- \"}) => any;\n\n\" }}\n        {%- else -%}\n            {{- \"() => any;\n\n\" }}\n        {%- endif -%}\n    {%- endfor %}\n    {{- \"} // namespace \" + namespace_name }}\n{%- endmacro -%}\n\n{%- macro render_builtin_tools(browser_tool, python_tool) -%}\n    {%- if browser_tool %}\n        {{- \"## browser\n\n\" }}\n        {{- \"// Tool for browsing.\n\" }}\n        {{- \"// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n\" }}\n        {{- \"// Cite information from the tool using the following format:\n\" }}\n        {{- \"// `„Äê{cursor}‚Ä†L{line_start}(-L{line_end})?„Äë`, for example: `„Äê6‚Ä†L9-L11„Äë` or `„Äê8‚Ä†L3„Äë`.\n\" }}\n        {{- \"// Do not quote more than 10 words directly from the tool output.\n\" }}\n        {{- \"// sources=web (default: web)\n\" }}\n        {{- \"namespace browser {\n\n\" }}\n        {{- \"// Searches for information related to `query` and displays `topn` results.\n\" }}\n        {{- \"type search = (_: {\n\" }}\n        {{- \"query: string,\n\" }}\n        {{- \"topn?: number, // default: 10\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n\" }}\n        {{- \"// Valid link ids are displayed with the formatting: `„Äê{id}‚Ä†.*„Äë`.\n\" }}\n        {{- \"// If `cursor` is not provided, the most recent page is implied.\n\" }}\n        {{- \"// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n\" }}\n        {{- \"// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n\" }}\n        {{- \"// Use this function without `id` to scroll to a new location of an opened page.\n\" }}\n        {{- \"type open = (_: {\n\" }}\n        {{- \"id?: number | string, // default: -1\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"loc?: number, // default: -1\n\" }}\n        {{- \"num_lines?: number, // default: -1\n\" }}\n        {{- \"view_source?: boolean, // default: false\n\" }}\n        {{- \"source?: string,\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n\" }}\n        {{- \"type find = (_: {\n\" }}\n        {{- \"pattern: string,\n\" }}\n        {{- \"cursor?: number, // default: -1\n\" }}\n        {{- \"}) => any;\n\n\" }}\n        {{- \"} // namespace browser\n\n\" }}\n    {%- endif -%}\n\n    {%- if python_tool %}\n        {{- \"## python\n\n\" }}\n        {{- \"Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n\" }}\n        {{- \"When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- System Message Construction ============================================ #}\n{%- macro build_system_message() -%}\n    {%- if model_identity is not defined %}\n        {%- set model_identity = \"You are ChatGPT, a large language model trained by OpenAI.\" %}\n    {%- endif %}\n    {{- model_identity + \"\n\" }}\n    {{- \"Knowledge cutoff: 2024-06\n\" }}\n    {{- \"Current date: \" + strftime_now(\"%Y-%m-%d\") + \"\n\n\" }}\n    {%- if reasoning_effort is not defined %}\n        {%- set reasoning_effort = \"medium\" %}\n    {%- endif %}\n    {{- \"Reasoning: \" + reasoning_effort + \"\n\n\" }}\n    {%- if builtin_tools %}\n        {{- \"# Tools\n\n\" }}\n        {%- set available_builtin_tools = namespace(browser=false, python=false) %}\n        {%- for tool in builtin_tools %}\n            {%- if tool == \"browser\" %}\n                {%- set available_builtin_tools.browser = true %}\n            {%- elif tool == \"python\" %}\n                {%- set available_builtin_tools.python = true %}\n            {%- endif %}\n        {%- endfor %}\n        {{- render_builtin_tools(available_builtin_tools.browser, available_builtin_tools.python) }}\n    {%- endif -%}\n    {{- \"# Valid channels: analysis, commentary, final. Channel must be included for every message.\" }}\n    {%- if tools -%}\n        {{- \"\nCalls to these tools must go to the commentary channel: 'functions'.\" }}\n    {%- endif -%}\n{%- endmacro -%}\n\n{#- Main Template Logic ================================================= #}\n{#- Set defaults #}\n\n{#- Render system message #}\n{{- \"<|start|>system<|message|>\" }}\n{{- build_system_message() }}\n{{- \"<|end|>\" }}\n\n{#- Extract developer message #}\n{%- if messages[0].role == \"developer\" or messages[0].role == \"system\" %}\n    {%- set developer_message = messages[0].content %}\n    {%- set loop_messages = messages[1:] %}\n{%- else %}\n    {%- set developer_message = \"\" %}\n    {%- set loop_messages = messages %}\n{%- endif %}\n\n{#- Render developer message #}\n{%- if developer_message or tools %}\n    {{- \"<|start|>developer<|message|>\" }}\n    {%- if developer_message %}\n        {{- \"# Instructions\n\n\" }}\n        {{- developer_message }}\n    {%- endif %}\n    {%- if tools -%}\n        {{- \"\n\n\" }}\n        {{- \"# Tools\n\n\" }}\n        {{- render_tool_namespace(\"functions\", tools) }}\n    {%- endif -%}\n    {{- \"<|end|>\" }}\n{%- endif %}\n\n{#- Render messages #}\n{%- set last_tool_call = namespace(name=none) %}\n{%- for message in loop_messages -%}\n    {#- At this point only assistant/user/tool messages should remain #}\n    {%- if message.role == 'assistant' -%}\n        {#- Checks to ensure the messages are being passed in the format we expect #}\n        {%- if \"content\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.content or \"<|channel|>final<|message|>\" in message.content %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the content field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"thinking\" in message %}\n            {%- if \"<|channel|>analysis<|message|>\" in message.thinking or \"<|channel|>final<|message|>\" in message.thinking %}\n                {{- raise_exception(\"You have passed a message containing <|channel|> tags in the thinking field. Instead of doing this, you should pass analysis messages (the string between '<|message|>' and '<|end|>') in the 'thinking' field, and final messages (the string between '<|message|>' and '<|end|>') in the 'content' field.\") }}\n            {%- endif %}\n        {%- endif %}\n        {%- if \"tool_calls\" in message %}\n            {#- We assume max 1 tool call per message, and so we infer the tool call name #}\n            {#- in \"tool\" messages from the most recent assistant tool call name #}\n            {%- set tool_call = message.tool_calls[0] %}\n            {%- if tool_call.function %}\n                {%- set tool_call = tool_call.function %}\n            {%- endif %}\n            {%- if message.content and message.thinking %}\n                {{- raise_exception(\"Cannot pass both content and thinking in an assistant message with tool calls! Put the analysis message in one or the other, but not both.\") }}\n            {%- elif message.content %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.content + \"<|end|>\" }}\n            {%- elif message.thinking %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {{- \"<|start|>assistant to=\" }}\n            {{- \"functions.\" + tool_call.name + \"<|channel|>commentary \" }}\n            {{- (tool_call.content_type if tool_call.content_type is defined else \"json\") + \"<|message|>\" }}\n            {{- tool_call.arguments|tojson }}\n            {{- \"<|call|>\" }}\n            {%- set last_tool_call.name = tool_call.name %}\n        {%- elif loop.last and not add_generation_prompt %}\n            {#- Only render the CoT if the final turn is an assistant turn and add_generation_prompt is false #}\n            {#- This is a situation that should only occur in training, never in inference. #}\n            {%- if \"thinking\" in message %}\n                {{- \"<|start|>assistant<|channel|>analysis<|message|>\" + message.thinking + \"<|end|>\" }}\n            {%- endif %}\n            {#- <|return|> indicates the end of generation, but <|end|> does not #}\n            {#- <|return|> should never be an input to the model, but we include it as the final token #}\n            {#- when training, so the model learns to emit it. #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|return|>\" }}\n        {%- else %}\n            {#- CoT is dropped during all previous turns, so we never render it for inference #}\n            {{- \"<|start|>assistant<|channel|>final<|message|>\" + message.content + \"<|end|>\" }}\n            {%- set last_tool_call.name = none %}\n        {%- endif %}\n    {%- elif message.role == 'tool' -%}\n        {%- if last_tool_call.name is none %}\n            {{- raise_exception(\"Message has tool role, but there was no previous assistant message with a tool call!\") }}\n        {%- endif %}\n        {{- \"<|start|>functions.\" + last_tool_call.name }}\n        {{- \" to=assistant<|channel|>commentary<|message|>\" + message.content|tojson + \"<|end|>\" }}\n    {%- elif message.role == 'user' -%}\n        {{- \"<|start|>user<|message|>\" + message.content + \"<|end|>\" }}\n    {%- endif -%}\n{%- endfor -%}\n\n{#- Generation prompt #}\n{%- if add_generation_prompt -%}\n<|start|>assistant\n{%- endif -%}"
                        },
                        "stopStrings": []
                      }
                    },
                    {
                      "key": "llm.prediction.llama.cpuThreads",
                      "value": 7
                    },
                    {
                      "key": "llm.prediction.contextPrefill",
                      "value": []
                    },
                    {
                      "key": "llm.prediction.temperature",
                      "value": 0.8
                    },
                    {
                      "key": "llm.prediction.topKSampling",
                      "value": 40
                    },
                    {
                      "key": "llm.prediction.topPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.8
                      }
                    },
                    {
                      "key": "llm.prediction.repeatPenalty",
                      "value": {
                        "checked": true,
                        "value": 1.1
                      }
                    },
                    {
                      "key": "llm.prediction.minPSampling",
                      "value": {
                        "checked": true,
                        "value": 0.05
                      }
                    },
                    {
                      "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
                      "value": "medium"
                    },
                    {
                      "key": "llm.prediction.tools",
                      "value": {
                        "type": "toolArray",
                        "tools": [
                          {
                            "type": "function",
                            "function": {
                              "name": "get_database_schema",
                              "description": "üîç Discover what data is available in the MIMIC-IV database.\n\n    **When to use:** Start here when you need to understand what tables exist, or when someone asks about data that might be in multiple tables.\n\n    **What this does:** Shows all available tables so you can identify which ones contain the data you need.\n\n    **Next steps after using this:**\n    - If you see relevant tables, use `get_table_info(table_name)` to explore their structure\n    - Common tables: `patients` (demographics), `admissions` (hospital stays), `icustays` (ICU data), `labevents` (lab results)\n\n    Returns:\n        List of all available tables in the database with current backend info\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {}
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_table_info",
                              "description": "üìã Explore a specific table's structure and see sample data.\n\n    **When to use:** After you know which table you need (from `get_database_schema()`), use this to understand the columns and data format.\n\n    **What this does:**\n    - Shows column names, types, and constraints\n    - Displays sample rows so you understand the actual data format\n    - Helps you write accurate SQL queries\n\n    **Pro tip:** Always look at sample data! It shows you the actual values, date formats, and data patterns.\n\n    Args:\n        table_name: Exact table name from the schema (case-sensitive). Can be simple name or fully qualified BigQuery name.\n        show_sample: Whether to include sample rows (default: True, recommended)\n\n    Returns:\n        Complete table structure with sample data to help you write queries\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "table_name": {
                                    "title": "Table Name",
                                    "type": "string"
                                  },
                                  "show_sample": {
                                    "default": true,
                                    "title": "Show Sample",
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "table_name"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "execute_mimic_query",
                              "description": "üöÄ Execute SQL queries to analyze MIMIC-IV data.\n\n    **üí° Pro tip:** For best results, explore the database structure first!\n\n    **Recommended workflow (especially for smaller models):**\n    1. **See available tables:** Use `get_database_schema()` to list all tables\n    2. **Examine table structure:** Use `get_table_info('table_name')` to see columns and sample data\n    3. **Write your SQL query:** Use exact table/column names from exploration\n\n    **Why exploration helps:**\n    - Table names vary between backends (SQLite vs BigQuery)\n    - Column names may be unexpected (e.g., age might be 'anchor_age')\n    - Sample data shows actual formats and constraints\n\n    Args:\n        sql_query: Your SQL SELECT query (must be SELECT only)\n\n    Returns:\n        Query results or helpful error messages with next steps\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "sql_query": {
                                    "title": "Sql Query",
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "sql_query"
                                ]
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_icu_stays",
                              "description": "üè• Get ICU stay information and length of stay data.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Patient IDs, admission times, length of stay, and ICU details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        limit: Maximum number of records to return (default: 10)\n\n    Returns:\n        ICU stay data as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_lab_results",
                              "description": "üß™ Get laboratory test results quickly.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Lab values, timestamps, patient IDs, and test details.\n\n    Args:\n        patient_id: Specific patient ID to query (optional)\n        lab_item: Lab item to search for in the value field (optional)\n        limit: Maximum number of records to return (default: 20)\n\n    Returns:\n        Lab results as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "patient_id": {
                                    "anyOf": [
                                      {
                                        "type": "integer"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Patient Id"
                                  },
                                  "lab_item": {
                                    "anyOf": [
                                      {
                                        "type": "string"
                                      },
                                      {
                                        "type": "null"
                                      }
                                    ],
                                    "default": null,
                                    "title": "Lab Item"
                                  },
                                  "limit": {
                                    "default": 20,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          },
                          {
                            "type": "function",
                            "function": {
                              "name": "get_race_distribution",
                              "description": "üìä Get race distribution from hospital admissions.\n\n    **‚ö†Ô∏è Note:** This is a convenience function that assumes standard MIMIC-IV table structure.\n    **For reliable queries:** Use `get_database_schema()` ‚Üí `get_table_info()` ‚Üí `execute_mimic_query()` workflow.\n\n    **What you'll get:** Count of patients by race category, ordered by frequency.\n\n    Args:\n        limit: Maximum number of race categories to return (default: 10)\n\n    Returns:\n        Race distribution as formatted text or guidance if table not found\n    ",
                              "parameters": {
                                "type": "object",
                                "properties": {
                                  "limit": {
                                    "default": 10,
                                    "title": "Limit",
                                    "type": "integer"
                                  }
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                "stats": {
                  "stopReason": "eosFound",
                  "tokensPerSecond": 29.701075178921478,
                  "numGpuLayers": -1,
                  "timeToFirstTokenSec": 4.874,
                  "totalTimeSec": 4.546,
                  "promptTokensCount": 4805,
                  "predictedTokensCount": 135,
                  "totalTokensCount": 4940
                }
              }
            },
            {
              "type": "debugInfoBlock",
              "stepIdentifier": "1758961236741-0.9550362495730235",
              "debugInfo": "Conversation naming technique: 'prompt'"
            }
          ],
          "senderInfo": {
            "senderName": "openai/gpt-oss-20b"
          }
        }
      ],
      "currentlySelected": 0
    }
  ],
  "usePerChatPredictionConfig": true,
  "perChatPredictionConfig": {
    "fields": [
      {
        "key": "ext.virtualModel.customField.openai.gptOss20b.reasoningEffort",
        "value": "medium"
      },
      {
        "key": "llm.prediction.systemPrompt",
        "value": "üí° **Recommended workflow:**\n        1. `get_database_schema()` ‚Üê See available tables\n        2. `get_table_info('table_name')` ‚Üê Explore structure\n        3. `execute_mimic_query('SELECT ...')` ‚Üê Run your analysis\"\"\"\n\n\nDon't suggest queries to run, but run them and give an answer at the end of your response!"
      }
    ]
  },
  "clientInput": "",
  "clientInputFiles": [],
  "userFilesSizeBytes": 0,
  "lastUsedModel": {
    "identifier": "openai/gpt-oss-20b",
    "indexedModelIdentifier": "openai/gpt-oss-20b",
    "instanceLoadTimeConfig": {
      "fields": []
    },
    "instanceOperationTimeConfig": {
      "fields": []
    }
  },
  "notes": [],
  "plugins": [
    "mcp/m3"
  ],
  "pluginConfigs": {},
  "disabledPluginTools": [],
  "looseFiles": []
}
